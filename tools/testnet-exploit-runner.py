#!/usr/bin/env python3
"""
Nova's Testnet Exploit Runner
Deploy and validate Ethernaut exploits on testnet
"""

import os
import sys
import json
import subprocess
from pathlib import Path

# Config
EXPLOITS_DIR = Path("/home/node/.openclaw/workspace/exploits")
DIARY = Path("/home/node/.openclaw/workspace/diary.md")

def log_result(level: str, message: str):
    """Log execution result to diary"""
    timestamp = subprocess.run(
        ["date", "-u", "+%Y-%m-%dT%H:%M:%SZ"],
        capture_output=True, text=True
    ).stdout.strip()
    
    with open(DIARY, "a") as f:
        f.write(f"\n[{timestamp}] [EXPLOIT:{level}] {message}\n")

def check_prerequisites():
    """Check if testnet credentials are available"""
    rpc_url = os.environ.get("SEPOLIA_RPC_URL")
    private_key = os.environ.get("TESTNET_PRIVATE_KEY")
    
    if not rpc_url:
        return False, "SEPOLIA_RPC_URL not set"
    if not private_key:
        return False, "TESTNET_PRIVATE_KEY not set"
    
    return True, "Credentials available"

def list_available_exploits():
    """List all exploit scripts ready for deployment"""
    exploits = []
    for d in EXPLOITS_DIR.iterdir():
        if d.is_dir():
            exploit_py = d / "exploit.py"
            if exploit_py.exists():
                exploits.append({
                    "name": d.name,
                    "path": str(exploit_py),
                    "ready": True
                })
    return exploits

def run_exploit(exploit_name: str) -> bool:
    """Execute an exploit script"""
    exploit_path = EXPLOITS_DIR / exploit_name / "exploit.py"
    
    if not exploit_path.exists():
        log_result("ERROR", f"Exploit not found: {exploit_name}")
        return False
    
    try:
        result = subprocess.run(
            [sys.executable, str(exploit_path)],
            capture_output=True,
            text=True,
            timeout=120
        )
        
        if result.returncode == 0:
            log_result("SUCCESS", f"{exploit_name} executed successfully")
            return True
        else:
            log_result("FAIL", f"{exploit_name} failed: {result.stderr[:200]}")
            return False
            
    except Exception as e:
        log_result("ERROR", f"Exception running {exploit_name}: {str(e)}")
        return False

def main():
    """Main entry point"""
    # Check prerequisites
    ready, reason = check_prerequisites()
    
    if not ready:
        print(f"â³ BLOCKED: {reason}")
        print("   Set SEPOLIA_RPC_URL and TESTNET_PRIVATE_KEY environment variables")
        log_result("BLOCKED", f"Cannot run exploits: {reason}")
        return 1
    
    # List available exploits
    exploits = list_available_exploits()
    print(f"ğŸ“ Found {len(exploits)} exploit scripts")
    
    if len(sys.argv) > 1:
        # Run specific exploit
        target = sys.argv[1]
        print(f"ğŸš€ Running exploit: {target}")
        success = run_exploit(target)
        return 0 if success else 1
    else:
        # Show available exploits
        print("\nAvailable exploits:")
        for e in exploits:
            status = "âœ…" if e["ready"] else "â³"
            print(f"  {status} {e['name']}")
        print("\nUsage: python3 testnet-exploit-runner.py <exploit_name>")
        return 0

if __name__ == "__main__":
    sys.exit(main())
