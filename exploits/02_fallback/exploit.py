#!/usr/bin/env python3
"""
Ethernaut Level 2: Fallback Exploit
Claim ownership and drain the contract
"""

from web3 import Web3
import os
import json

# Fallback contract ABI (minimal)
FALLBACK_ABI = [
    {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
    {"inputs": [], "name": "contribute", "outputs": [], "stateMutability": "payable", "type": "function"},
    {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "contributions", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
    {"inputs": [], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [], "name": "getContribution", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
    {"stateMutability": "payable", "type": "receive"}
]

RPC_URL = "https://rpc.sepolia.org"

def load_credentials():
    """Load wallet credentials from secure storage"""
    creds_path = "/home/node/.openclaw/workspace/.secure/wallet.json"
    if os.path.exists(creds_path):
        with open(creds_path) as f:
            data = json.load(f)
            # Extract private key from wallet format
            if 'private_key' in data:
                return data
            elif 'accounts' in data and len(data['accounts']) > 0:
                return {'private_key': data['accounts'][0]['private_key']}
    return None

def main():
    print("=" * 60)
    print("Ethernaut Level 2: Fallback Exploit")
    print("=" * 60)
    
    creds = load_credentials()
    if not creds:
        print("âŒ No credentials found")
        return
    
    # Get contract address
    contract_address = input("\nEnter Fallback contract instance address: ").strip()
    if not contract_address:
        print("âŒ Contract address required")
        return
    
    # Connect
    w3 = Web3(Web3.HTTPProvider(RPC_URL))
    if not w3.is_connected():
        print("âŒ Failed to connect to Sepolia")
        return
    
    account = w3.eth.account.from_key(creds['private_key'])
    contract = w3.eth.contract(address=contract_address, abi=FALLBACK_ABI)
    
    print(f"\nğŸ”— Connected to Sepolia")
    print(f"ğŸ‘¤ Attacker: {account.address}")
    
    # Check current state
    owner = contract.functions.owner().call()
    balance = w3.eth.get_balance(contract_address)
    contribution = contract.functions.getContribution().call({'from': account.address})
    
    print(f"\nğŸ“Š Contract State:")
    print(f"   Owner: {owner}")
    print(f"   Balance: {w3.from_wei(balance, 'ether')} ETH")
    print(f"   Your contribution: {w3.from_wei(contribution, 'ether')} ETH")
    
    if owner.lower() == account.address.lower():
        print("\nâœ… Already owner! Withdrawing funds...")
    else:
        print("\nğŸ¯ Exploit Strategy:")
        print("   1. contribute() with small amount")
        print("   2. Send ETH to trigger receive() â†’ become owner")
        print("   3. withdraw() to drain contract")
    
    print("\nâš ï¸  Manual execution required:")
    print("   1. Go to Ethernaut UI and get instance")
    print("   2. Update contract address above")
    print("   3. Run with --execute flag when ready")

if __name__ == "__main__":
    main()
