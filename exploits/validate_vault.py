#!/usr/bin/env python3
"""
Ethernaut Level 8: Vault - Exploit Validator
Validates storage slot reading exploit without on-chain execution
"""

class MockVault:
    """Contract with 'private' password that can be read from storage"""
    
    def __init__(self, password):
        # Storage slot 0: locked (bool)
        self.locked = True
        # Storage slot 1: password (bytes32)
        self.password = password  # 'private' but readable!
    
    def unlock(self, _password):
        if self.password == _password:
            self.locked = False
            return True
        return False
    
    def is_locked(self):
        return self.locked
    
    def get_storage_at(self, slot):
        """Simulate reading from blockchain storage"""
        if slot == 0:
            return self.locked
        elif slot == 1:
            return self.password
        return None

def run_exploit():
    """Execute the storage reading exploit and validate"""
    print("=" * 60)
    print("Ethernaut Level 8: Vault - Exploit Simulation")
    print("=" * 60)
    
    # Setup with secret password
    secret_password = "A_VERY_SECRET_PASSWORD_123456789"
    vault = MockVault(secret_password)
    
    print("\n[SETUP] Vault contract deployed")
    print(f"  Locked: {vault.is_locked()}")
    print(f"  Password stored as 'private' bytes32")
    print(f"  Secret: {'*' * len(secret_password)}")
    
    # Pre-check
    assert vault.is_locked() == True, "Vault should start locked"
    print("  âœ“ Vault is locked")
    
    # Step 1: Read storage slot 0 (locked)
    print("\n[STEP 1] Reading storage slot 0...")
    slot0 = vault.get_storage_at(0)
    print(f"  Slot 0 value: {slot0}")
    print("  âœ“ PASS (this is the 'locked' boolean)")
    
    # Step 2: Read storage slot 1 (password)
    print("\n[STEP 2] Reading storage slot 1...")
    print("  Even though password is 'private', we can read it!")
    
    slot1 = vault.get_storage_at(1)
    print(f"  Slot 1 value: {slot1}")
    
    assert slot1 == secret_password, "Should read the actual password"
    print("  âœ“ PASS - Password revealed!")
    
    # Step 3: Unlock with discovered password
    print("\n[STEP 3] Unlocking vault with discovered password...")
    result = vault.unlock(slot1)
    
    assert result == True, "Unlock should succeed"
    print("  âœ“ PASS - Vault unlocked!")
    
    # Step 4: Verify vault is unlocked
    print("\n[STEP 4] Verifying vault state...")
    is_locked = vault.is_locked()
    print(f"  Locked: {is_locked}")
    
    assert is_locked == False, "Vault should be unlocked"
    print("  âœ“ PASS - Challenge complete!")
    
    print("\n" + "=" * 60)
    print("ðŸŽ‰ EXPLOIT VALIDATION SUCCESSFUL!")
    print("")
    print("Key Insight:")
    print("  'private' in Solidity != secret")
    print("  All blockchain storage is PUBLIC - anyone can read any slot!")
    print("  Never store passwords, keys, or secrets on-chain.")
    print("=" * 60)
    
    return True

if __name__ == "__main__":
    success = run_exploit()
    exit(0 if success else 1)
