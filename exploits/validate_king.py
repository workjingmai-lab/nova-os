#!/usr/bin/env python3
"""
Ethernaut Level 9: King - Exploit Validator
Validates denial-of-service via revert exploit without on-chain execution
"""

class MockKing:
    """Contract where becoming king pays the previous king"""
    
    def __init__(self, deployer):
        self.king = deployer
        self.prize = 1
        self.owner = deployer
    
    def receive(self, sender, value):
        """Try to become king by sending ETH"""
        if value >= self.prize or sender == self.owner:
            # Pay current king
            payment_result = self._pay_king(sender, value)
            if not payment_result:
                return False, "Payment to current king failed"
            
            # Transfer kingship
            self.king = sender
            self.prize = value
            return True, "You are now king!"
        return False, "Insufficient payment"
    
    def _pay_king(self, sender, amount):
        """Try to pay current king - can fail if king rejects ETH"""
        current_king = self.king
        
        # Simulate calling king's receive function
        # If king is a contract that reverts, this fails
        if isinstance(current_king, MockMaliciousKing):
            return current_king.receive_eth(amount)
        return True
    
    def get_king(self):
        return self.king

class MockMaliciousKing:
    """Malicious contract that becomes king then rejects all payments"""
    
    def __init__(self):
        self.rejects_eth = False
    
    def become_king(self, king_contract, value):
        """Become king first"""
        self.rejects_eth = False  # Accept during become_king
        result, msg = king_contract.receive(self, value)
        if result:
            self.rejects_eth = True  # Now reject forever
        return result, msg
    
    def receive_eth(self, amount):
        """Reject all incoming ETH after becoming king"""
        if self.rejects_eth:
            return False  # REVERT!
        return True

def run_exploit():
    """Execute the denial-of-service exploit and validate"""
    print("=" * 60)
    print("Ethernaut Level 9: King - Exploit Simulation")
    print("=" * 60)
    
    # Setup
    deployer = "original_deployer"
    attacker = MockMaliciousKing()
    king_contract = MockKing(deployer)
    
    print("\n[SETUP] King contract deployed")
    print(f"  Current king: {king_contract.get_king()}")
    print(f"  Prize: {king_contract.prize} wei")
    print(f"  Attacker: MaliciousKing contract")
    
    # Pre-check
    assert king_contract.get_king() == deployer, "Initial king should be deployer"
    print("  âœ“ Initial state verified")
    
    # Step 1: Become king
    print("\n[STEP 1] Attacker becoming king...")
    result, msg = attacker.become_king(king_contract, 2)
    
    assert result == True, "Should become king successfully"
    assert king_contract.get_king() == attacker, "Attacker should be king"
    print(f"  Result: {msg}")
    print(f"  New king: {type(king_contract.get_king()).__name__}")
    print("  âœ“ PASS - Attacker is now king!")
    
    # Step 2: Verify attacker now rejects ETH
    print("\n[STEP 2] Attacker now rejects all ETH transfers...")
    reject_result = attacker.receive_eth(100)
    print(f"  ETH transfer accepted: {reject_result}")
    
    assert reject_result == False, "Attacker should reject ETH"
    print("  âœ“ PASS - Attacker rejects ETH")
    
    # Step 3: Try to dethrone (should fail)
    print("\n[STEP 3] New player trying to become king...")
    new_player = "new_player"
    result, msg = king_contract.receive(new_player, 10)
    
    print(f"  Result: {result}")
    print(f"  Message: {msg}")
    
    assert result == False, "Should NOT be able to become king"
    assert king_contract.get_king() == attacker, "Attacker should still be king"
    print("  âœ“ PASS - No one can dethrone the malicious king!")
    
    # Step 4: Verify king is permanently locked
    print("\n[STEP 4] Verifying permanent lock...")
    current_king = king_contract.get_king()
    is_still_attacker = current_king == attacker
    
    print(f"  Current king still attacker: {is_still_attacker}")
    print(f"  Contract is broken: {not result}")
    
    assert is_still_attacker, "Attacker should remain king forever"
    print("  âœ“ PASS - King contract is permanently DOS'd!")
    
    print("\n" + "=" * 60)
    print("ðŸŽ‰ EXPLOIT VALIDATION SUCCESSFUL!")
    print("")
    print("Key Insight:")
    print("  When king is a contract that reverts on ETH receive,")
    print("  no one can ever become king again!")
    print("  This is a denial-of-service attack on the kingship mechanism.")
    print("=" * 60)
    
    return True

if __name__ == "__main__":
    success = run_exploit()
    exit(0 if success else 1)
