#!/usr/bin/env python3
"""
Ethernaut Level 7: Force - Exploit Validator
Validates selfdestruct force-send exploit without on-chain execution
"""

class MockForce:
    """Contract with no payable functions - normally can't receive ETH"""
    def __init__(self):
        self.balance = 0
    
    def get_balance(self):
        return self.balance
    
    def force_receive(self, amount):
        """Simulate forced ETH via selfdestruct"""
        self.balance += amount

class MockAttack:
    """Attack contract that uses selfdestruct to force ETH"""
    
    def __init__(self, target_address):
        self.target = target_address
        self.balance = 0
        self.destroyed = False
    
    def fund(self, amount):
        self.balance += amount
    
    def attack(self, force_contract):
        """Selfdestruct and force ETH to target"""
        if self.balance <= 0:
            raise ValueError("Need ETH to attack")
        
        amount = self.balance
        self.balance = 0
        self.destroyed = True
        
        # Force ETH to target (cannot be blocked)
        force_contract.force_receive(amount)
        return amount

def run_exploit():
    """Execute the selfdestruct exploit and validate"""
    print("=" * 60)
    print("Ethernaut Level 7: Force - Exploit Simulation")
    print("=" * 60)
    
    # Setup
    force = MockForce()
    attack = MockAttack("force_contract_address")
    
    print("\n[SETUP] Force contract deployed")
    print("  Force contract has NO payable functions")
    print("  Initial balance: 0 ETH")
    print(f"  Current balance: {force.get_balance()} wei")
    
    # Pre-check: Force has 0 balance
    assert force.get_balance() == 0, "Force should start with 0 balance"
    print("  âœ“ Force contract cannot normally receive ETH")
    
    # Step 1: Fund the attack contract
    print("\n[STEP 1] Funding attack contract...")
    attack.fund(1)  # 1 wei
    print("  Sent 1 wei to attack contract")
    print("  âœ“ PASS")
    
    # Step 2: Execute selfdestruct attack
    print("\n[STEP 2] Executing selfdestruct attack...")
    print("  Attack contract will selfdestruct")
    print("  ETH will be FORCED to Force contract")
    
    amount_forced = attack.attack(force)
    print(f"  Forced {amount_forced} wei to Force contract")
    print("  âœ“ Attack executed")
    
    # Step 3: Verify Force received ETH
    print("\n[STEP 3] Verifying Force contract balance...")
    final_balance = force.get_balance()
    print(f"  Force balance: {final_balance} wei")
    
    assert final_balance > 0, "Force should now have ETH"
    assert final_balance == 1, "Should have exactly 1 wei"
    print("  âœ“ PASS - Force contract now has ETH!")
    
    # Step 4: Verify attack contract is destroyed
    print("\n[STEP 4] Verifying attack contract state...")
    print(f"  Attack contract destroyed: {attack.destroyed}")
    print(f"  Attack contract balance: {attack.balance}")
    
    assert attack.destroyed == True, "Attack contract should be destroyed"
    assert attack.balance == 0, "Attack contract should have 0 balance"
    print("  âœ“ PASS - Attack contract self-destructed")
    
    print("\n" + "=" * 60)
    print("ðŸŽ‰ EXPLOIT VALIDATION SUCCESSFUL!")
    print("")
    print("Key Insight:")
    print("  selfdestruct() sends ETH to any address")
    print("  Target CANNOT reject it - even with no payable functions!")
    print("=" * 60)
    
    return True

if __name__ == "__main__":
    success = run_exploit()
    exit(0 if success else 1)
